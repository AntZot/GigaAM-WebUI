<!DOCTYPE html>
<html lang="ru">
<head>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {

        const response = await fetch('/cookie', {
          method: 'POST',
          credentials: 'include'
        });
        console.log(response)
        if (!response.ok){
          console.log("—Ç—É—Ç–∞")
          throw new Error(`–ë–µ–∫ –Ω–µ –æ—Ç–¥–∞–ª —Å–µ—Å—Å–∏—é ${response.status}`)
        }
        mainScript()
      } catch (error) {
        console.error(error);
      }
    });
    function mainScript(){
      const uploadForm = document.getElementById('uploadForm');
      const resultText = document.getElementById('resultText');
      const fileList = document.getElementById('fileList');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const uploadStatus = document.getElementById('uploadStatus');
      const processButton = document.getElementById('processButton');
      const spinner = document.getElementById('spinner');

      uploadForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const formData = new FormData(uploadForm);
          const xhr = new XMLHttpRequest();

          xhr.open('POST', '/uploadfile');

          xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
              const percent = Math.round((e.loaded / e.total) * 100);
              progressContainer.style.display = 'block';
              progressBar.style.width = percent + '%';
              progressBar.textContent = percent + '%';
            }
          });

          xhr.onload = () => {
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressContainer.style.display = 'none';

            if (xhr.status === 200) {
              uploadStatus.textContent = '–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω.';
              resultText.textContent = xhr.responseText;
              processButton.style.display = 'inline-block';
              fetchFiles();
            } else {
              resultText.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + xhr.status;
              uploadStatus.textContent = '';
            }
          };

          xhr.onerror = () => {
            resultText.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ.';
            uploadStatus.textContent = '';
            progressContainer.style.display = 'none';
          };

          xhr.send(formData);
      });

      processButton.addEventListener('click', async () => {
        spinner.style.display = 'inline-block';
        resultText.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...';
        try {
          const response = await fetch('/process', { method: 'POST' });

          if (response.ok) {
            // –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            await fetchResult();
          } else {
            resultText.textContent = '–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å ' + response.status;
          }
        } catch {
          resultText.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É.';
        } finally {
          spinner.style.display = 'none';
        }
      });

      fetchFiles();
      fetchResult();

      setInterval(() => {
          fetchFiles();
          fetchResult();
        }, 5000);
    }

    async function fetchFiles() {
      try {
        const response = await fetch('/files');
        const files = await response.json();

        fileList.innerHTML = '';
        files.forEach(file => {
          const li = document.createElement('li');
          li.className = 'file-item';

          const link = document.createElement('a');
          link.href = `/files/${encodeURIComponent(file)}`;
          link.textContent = file;
          link.className = 'download-link';
          link.download = file;

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = 'üóë –£–¥–∞–ª–∏—Ç—å';
          deleteBtn.addEventListener('click', () => deleteFile(file));

          const actions = document.createElement('div');
          actions.className = 'file-actions';
          actions.appendChild(link);
          actions.appendChild(deleteBtn);

          li.appendChild(actions);
          fileList.appendChild(li);
        });
      } catch {
        fileList.innerHTML = '<li>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤</li>';
      }
    }

    async function deleteFile(fileName) {
      const confirmDelete = confirm(`–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª "${fileName}"?`);
      if (!confirmDelete) return;

      try {
        const response = await fetch(`/files/${encodeURIComponent(fileName)}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          fetchFiles();
          resultText.textContent = `–§–∞–π–ª "${fileName}" —É–¥–∞–ª—ë–Ω.`;
        } else {
          resultText.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª "${fileName}".`;
        }
      } catch {
        resultText.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞.';
      }
    }
    async function fetchResult() {
      try {
        const response = await fetch('/result');
        const text = await response.text();
        resultText.textContent = text;
      } catch {
        resultText.textContent = '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.';
      }
    }
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2em;
    }
    .container {
      max-width: 1000px;
      margin: auto;
    }
    .progress {
      width: 100%;
      background-color: #f3f3f3;
      border: 1px solid #ccc;
      height: 20px;
      margin-top: 10px;
      position: relative;
    }
    .progress-bar {
      height: 100%;
      background-color: #4caf50;
      width: 0%;
      text-align: center;
      color: white;
      line-height: 20px;
      transition: width 0.3s;
    }
    .horizontal-blocks {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      align-items: flex-start;
    }
    .files, .result {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      min-width: 0;
    }
    .files ul {
      padding-left: 20px;
      margin: 0;
    }
    #resultText {
      white-space: pre-wrap;
      font-family: monospace;
      word-break: break-word;
    }
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    .file-actions {
      display: flex;
      gap: 10px;
    }
    .delete-btn {
      background: none;
      border: none;
      color: red;
      cursor: pointer;
      font-size: 14px;
    }
    .delete-btn:hover {
      text-decoration: underline;
    }
    #processButton {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #uploadStatus {
      margin-top: 10px;
      font-style: italic;
      color: green;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</h1>
    <form id="uploadForm">
      <input type="file" name="file" required />
      <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>

    <div class="progress" id="progressContainer" style="display: none;">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div id="uploadStatus"></div>

    <button id="processButton" style="display: none;">–ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</button>
    <span id="spinner" class="spinner" style="display: none;"></span>

    <div class="horizontal-blocks">
      <div class="files">
        <strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã:</strong>
        <ul id="fileList">
          <li>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</li>
        </ul>
      </div>

      <div class="result">
        <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong>
        <div id="resultText">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
      </div>
    </div>
  </div>

  <script>


  </script>
</body>
</html>
